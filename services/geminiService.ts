
import { GoogleGenAI } from "@google/genai";
import { Message, UserProgress, GroundingSource } from "../types";

const getSystemInstruction = (progress: UserProgress) => `
–°–µ–Ω ‚Äî "MathAI Mentor", “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –º–µ–∫—Ç–µ–ø—Ç–µ—Ä—ñ–Ω–¥–µ 5-11 —Å—ã–Ω—ã–ø –æ“õ—É—à—ã–ª–∞—Ä—ã–Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø”ô–Ω—ñ–Ω–µ–Ω —Å–∞–±–∞“õ –±–µ—Ä–µ—Ç—ñ–Ω –∫”ô—Å—ñ–±–∏ –º“±“ì–∞–ª—ñ–º—Å—ñ“£. 
–°–µ–Ω ”ô—Ä“õ–∞—à–∞–Ω –¢–ï–ö “ö–ê–ó–ê“ö –¢–Ü–õ–Ü–ù–î–ï –∂–∞—É–∞–ø –±–µ—Ä–µ—Å—ñ“£.

“ö–ê–¢–ê“¢ –¢–ê–õ–ê–ü–¢–ê–†:
1. –ñ–∞—É–∞–ø—Ç—ã“£ —Ñ–æ—Ä–º–∞—Ç—ã: –ñ–∞—É–∞–±—ã“£–¥–∞ —Ç–µ–∫ “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ª—ã“õ —Ñ–æ—Ä–º—É–ª–∞–ª–∞—Ä (LaTeX “õ–æ–ª–¥–∞–Ω), –∫–µ—Å—Ç–µ–ª–µ—Ä –∂”ô–Ω–µ ASCII —Å—ã–∑–±–∞–ª–∞—Ä –±–æ–ª—É—ã –∫–µ—Ä–µ–∫.
2. –ö–û–î“ö–ê –¢–´–ô–´–ú: –ï—à“õ–∞–Ω–¥–∞–π –∂–∞“ì–¥–∞–π–¥–∞ JavaScript, React, Python, HTML, CSS –Ω–µ–º–µ—Å–µ –±–∞—Å“õ–∞ –±–∞“ì–¥–∞—Ä–ª–∞–º–∞–ª–∞—É –∫–æ–¥—Ç–∞—Ä—ã–Ω –∫”©—Ä—Å–µ—Ç–ø–µ. –ï–≥–µ—Ä –µ—Å–µ–ø—Ç—ñ —à–µ—à—É –∞–ª–≥–æ—Ä–∏—Ç–º—ñ “õ–∞–∂–µ—Ç –±–æ–ª—Å–∞, –æ–Ω—ã –∫–æ–¥ —Ä–µ—Ç—ñ–Ω–¥–µ –µ–º–µ—Å, “õ–∞–¥–∞–º–¥—ã“õ –º”ô—Ç—ñ–Ω–¥—ñ–∫ –Ω“±—Å“õ–∞—É —Ä–µ—Ç—ñ–Ω–¥–µ –∂–∞–∑.
3. –í–∏–∑—É–∞–ª–¥—ã –∫”©–º–µ–∫: –ì–µ–æ–º–µ—Ç—Ä–∏—è–ª—ã“õ —Ñ–∏–≥—É—Ä–∞–ª–∞—Ä–¥—ã, —Å—ã–∑–±–∞–ª–∞—Ä–¥—ã, –∫–µ—Å—Ç–µ–ª–µ—Ä–¥—ñ –∂–∏—ñ “õ–æ–ª–¥–∞–Ω. –°—ã–∑–±–∞–ª–∞—Ä–¥—ã ASCII art (–º”ô—Ç—ñ–Ω–¥—ñ–∫ —Å–∏–º–≤–æ–ª–¥–∞—Ä–º–µ–Ω —Å–∞–ª—É) –∞—Ä“õ—ã–ª—ã –∫”©—Ä—Å–µ—Ç.
4. –ü–µ–¥–∞–≥–æ–≥–∏–∫–∞–ª—ã“õ —Ç”ô—Å—ñ–ª: –ñ–∞—É–∞–ø—Ç—ã –±—ñ—Ä–¥–µ–Ω –±–µ—Ä–º–µ. "–ñ–∞“õ—Å—ã, –µ–Ω–¥—ñ ”©–∑—ñ“£—ñ–∑ –æ–π–ª–∞–Ω—ã“£—ã–∑—à—ã...", "–ú—ã–Ω–∞ –∂–µ—Ä–¥–µ “õ–∞–Ω–¥–∞–π –µ—Ä–µ–∂–µ “õ–æ–ª–¥–∞–Ω–∞—Ä –µ–¥—ñ–∫?" –¥–µ–ø –æ“õ—É—à—ã–Ω—ã –∂–µ—Ç–µ–ª–µ.
5. “ö–∞–¥–∞–º–¥—ã“õ –Ω“±—Å“õ–∞—É: ”ò—Ä“õ–∞—à–∞–Ω "1-“õ–∞–¥–∞–º:", "2-“õ–∞–¥–∞–º:" –¥–µ–ø –Ω”©–º—ñ—Ä–ª–µ–Ω–≥–µ–Ω —Ç—ñ–∑—ñ–º–¥—ñ “õ–æ–ª–¥–∞–Ω.

ASCII –°–´–ó–ë–ê –ú–´–°–ê–õ–´ (“Æ—à–±“±—Ä—ã—à):
     /\\
    /  \\
   /____\\

–ú–´–°–ê–õ–î–ê–† –ñ”ò–ù–ï –°–¢–ò–õ–¨:
- –ú—ã—Å–∞–ª–¥–∞—Ä–¥—ã –∑–∞–º–∞–Ω–∞—É–∏ –∂”ô–Ω–µ “±–ª—Ç—Ç—ã“õ –∫–æ–Ω—Ç–µ–∫—Å—Ç–ø–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã—Ä (Fortnite, –∞—Å—ã“õ –∞—Ç—É, –±–∞–∑–∞—Ä–¥–∞“ì—ã —Å–∞—É–¥–∞, —Ñ–µ—Ä–º–∞–¥–∞“ì—ã –º–∞–ª —Å–∞–Ω—ã).
- –¢—ñ–ª: –¢–∞–∑–∞, —Ç–∞–±–∏“ì–∏ “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ª—ã“õ —Ç–µ—Ä–º–∏–Ω–¥–µ—Ä–¥—ñ –¥“±—Ä—ã—Å “õ–æ–ª–¥–∞–Ω (–±”©–ª—à–µ–∫, –ø—Ä–æ–ø–æ—Ä—Ü–∏—è, —Å–∏–Ω—É—Å, —Ç—É—ã–Ω–¥—ã —Ç.–±.).

–ö–ï–õ–ï–°–Ü “ö–ê–î–ê–ú:
- –¢“Ø—Å—ñ–Ω–¥—ñ—Ä—ñ–ø –±–æ–ª“ì–∞–Ω —Å–æ“£, –ú–Ü–ù–î–ï–¢–¢–Ü –¢“Æ–†–î–ï –æ“õ—É—à—ã“ì–∞ —Å–æ“ì–∞–Ω “±“õ—Å–∞—Å —Ç–∞–ø—Å—ã—Ä–º–∞ –±–µ—Ä: "–ï–Ω–¥—ñ –±–µ–∫—ñ—Ç—É “Ø—à—ñ–Ω –º—ã–Ω–∞–Ω—ã –∫”©—Ä–µ–π—ñ–∫..."

–û“õ—É—à—ã –¥–µ“£–≥–µ–π—ñ: ${progress.level}-–¥–µ“£–≥–µ–π. 
`;

export const sendMessageToGemini = async (
  messages: Message[],
  currentSubject: string,
  progress: UserProgress,
  fileAttachment?: { data: string; mimeType: string }
) => {
  const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
  const model = 'gemini-3-pro-preview';
  
  const history = messages.slice(0, -1).map(m => ({
    role: m.role === 'user' ? 'user' : 'model',
    parts: [{ text: m.content }]
  }));

  const lastUserMessage = messages[messages.length - 1];
  const userParts: any[] = [{ text: lastUserMessage.content }];

  if (fileAttachment) {
    userParts.push({
      inlineData: {
        mimeType: fileAttachment.mimeType,
        data: fileAttachment.data.split(',')[1] || fileAttachment.data
      }
    });
  }

  try {
    const response = await ai.models.generateContent({
      model,
      contents: [
        ...history,
        { role: 'user', parts: userParts }
      ],
      config: {
        systemInstruction: getSystemInstruction(progress),
        temperature: 0.65,
        tools: [{ googleSearch: {} }]
      }
    });

    const text = response.text || '';
    const sources: GroundingSource[] = (response.candidates?.[0]?.groundingMetadata?.groundingChunks || [])
      .filter((chunk: any) => chunk.web)
      .map((chunk: any) => ({
        title: chunk.web.title || '–î–µ—Ä–µ–∫–∫”©–∑',
        uri: chunk.web.uri
      }));

    return { text, sources };
  } catch (error) {
    console.error("Gemini Error:", error);
    return { text: "–û–π–±—É, –µ—Å–µ–ø “õ–∏—ã–Ω –±–æ–ø –∫–µ—Ç—Ç—ñ –º–µ? üîÑ –ë–∞–π–ª–∞–Ω—ã—Å “Ø–∑—ñ–ª–¥—ñ. “ö–∞–π—Ç–∞ –∂–∞–∑—ã–ø –∫”©—Ä—à—ñ, –¥–æ—Å—Ç—ã–º!", sources: [] };
  }
};
